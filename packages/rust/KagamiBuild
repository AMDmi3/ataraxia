# Description: Systems programming language focused on safety, speed and concurrency
# URL:         https://www.rust-lang.org/
# Maintainer:  protonesso, nagakamira at gmail dot com
# Section:     devel

name=rust
version=1.42.0
release=1
options=('~emptydirs')
source=("https://portage.smaeul.xyz/distfiles/rust-$version-aarch64-gentoo-linux-musl.tar.xz"
	"https://portage.smaeul.xyz/distfiles/rust-$version-armv7a-unknown-linux-musleabihf.tar.xz"
	"https://portage.smaeul.xyz/distfiles/rust-$version-i686-gentoo-linux-musl.tar.xz"
	"https://portage.smaeul.xyz/distfiles/rust-$version-x86_64-gentoo-linux-musl.tar.xz")

clear_vendor_checksums() {
	sed -i 's/\("files":{\)[^}]*/\1/' vendor/$1/.cargo-checksum.json
}

build() {
	export RUSTFLAGS="-C link-args=-lffi"
	export MUSL_ROOT=/usr
	export RUST_BACKTRACE=1

	case $BARCH in
		x86_64)
			export RTARGET="x86_64-gentoo-linux-musl"
			;;
		i586)
			export RTARGET="i686-gentoo-linux-musl"
			;;
		aarch64)
			export RTARGET="aarch64-gentoo-linux-musl"
			;;
		armv7hnl|armv7hl)
			export RTARGET="armv7a-gentoo-linux-musleabihf"
			;;
		*)
			die "Architecture is not set or is not supported by Rust Language"
	esac
	
	cd "$SRC"/rust-$version-$RTARGET
	bash install.sh \
		--prefix=/usr \
		--destdir="$PKG" \
		--disable-ldconfig

	mv "$PKG"/usr/etc/bash_completion.d "$PKG"/usr/share
	rm -rf "$PKG"/usr/etc
}
